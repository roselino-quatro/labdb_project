<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}CEFER Management{% endblock %}</title>
    <link rel="icon" href="https://www.usp.br/favicon.ico" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        uspprimary: '#1094ab',
                        uspsecondary: '#64c4d2',
                        uspyellow: '#fcb421',
                        uspgray: '#e5e7eb'
                    }
                }
            }
        };
    </script>
    {% block head_extra %}{% endblock %}
</head>
<body class="{{ body_class if body_class else 'min-h-screen bg-gray-100 text-gray-900 flex flex-col' }}">
    {% if not hide_navbar %}
        {% include 'partials/navbar.html' %}
    {% endif %}
    <main class="{{ main_class if main_class else 'mx-auto w-full max-w-6xl p-6 flex-1' }}">
        {% include 'partials/messages.html' %}
        {% block content %}{% endblock %}
    </main>
    {% if not hide_footer %}
        <footer class="bg-white py-4 text-sm text-gray-500 shadow-inner mt-auto">
            <div class="container mx-auto flex items-center justify-between px-6">
                <span>CEFER USP &copy; {{ current_year if current_year else '2025' }}</span>
            </div>
        </footer>
    {% endif %}

    <!-- Debug Buttons (Floating) -->
    <div id="debug-buttons" class="fixed bottom-6 right-6 z-50 flex flex-col gap-3">
        <button
            id="populate-db-btn"
            class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-full shadow-lg transition-all duration-200 transform hover:scale-105 active:scale-95 flex items-center gap-2"
            title="Popular banco de dados"
        >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            <span>Popular DB</span>
        </button>
        <button
            id="clear-db-btn"
            class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-full shadow-lg transition-all duration-200 transform hover:scale-105 active:scale-95 flex items-center gap-2"
            title="Limpar banco de dados"
        >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
            </svg>
            <span>Limpar DB</span>
        </button>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4">
            <div class="flex items-center gap-4">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <div>
                    <p class="font-semibold text-gray-900" id="loading-message">Processando...</p>
                    <p class="text-sm text-gray-500">Por favor, aguarde</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="hidden fixed top-6 right-6 z-50 max-w-sm w-full">
        <div class="bg-white rounded-lg shadow-xl p-4 border-l-4" id="toast-content">
            <div class="flex items-start">
                <div id="toast-icon" class="flex-shrink-0"></div>
                <div class="ml-3 flex-1">
                    <p id="toast-message" class="text-sm font-medium text-gray-900"></p>
                </div>
                <button id="toast-close" class="ml-4 flex-shrink-0 text-gray-400 hover:text-gray-500">
                    <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Debug buttons functionality
        (function() {
            const populateBtn = document.getElementById('populate-db-btn');
            const clearBtn = document.getElementById('clear-db-btn');
            const loadingOverlay = document.getElementById('loading-overlay');
            const loadingMessage = document.getElementById('loading-message');
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            const toastIcon = document.getElementById('toast-icon');
            const toastContent = document.getElementById('toast-content');
            const toastClose = document.getElementById('toast-close');

            function showLoading(message) {
                loadingMessage.textContent = message;
                loadingOverlay.classList.remove('hidden');
            }

            function hideLoading() {
                loadingOverlay.classList.add('hidden');
            }

            function showToast(message, type = 'success') {
                const isSuccess = type === 'success';
                toastMessage.textContent = message;
                toastContent.className = `bg-white rounded-lg shadow-xl p-4 border-l-4 ${isSuccess ? 'border-green-500' : 'border-red-500'}`;

                toastIcon.innerHTML = isSuccess
                    ? '<svg class="h-6 w-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
                    : '<svg class="h-6 w-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';

                toast.classList.remove('hidden');

                setTimeout(() => {
                    toast.classList.add('hidden');
                }, 5000);
            }

            toastClose.addEventListener('click', () => {
                toast.classList.add('hidden');
            });

            async function populateDatabase() {
                if (!confirm('Tem certeza que deseja popular o banco de dados? Isso pode levar alguns minutos.')) {
                    return;
                }

                showLoading('Gerando dados sintéticos e populando banco...');
                populateBtn.disabled = true;
                clearBtn.disabled = true;

                try {
                    const response = await fetch('/debug/populate-db', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    const data = await response.json();

                    if (data.success) {
                        showToast(data.message, 'success');
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    } else {
                        showToast(data.message || 'Erro ao popular banco de dados', 'error');
                    }
                } catch (error) {
                    showToast('Erro ao popular banco de dados: ' + error.message, 'error');
                } finally {
                    hideLoading();
                    populateBtn.disabled = false;
                    clearBtn.disabled = false;
                }
            }

            async function clearDatabase() {
                if (!confirm('ATENÇÃO: Tem certeza que deseja APAGAR TODOS os dados do banco? Esta ação não pode ser desfeita!')) {
                    return;
                }

                if (!confirm('Confirma novamente: Todos os dados serão PERMANENTEMENTE apagados!')) {
                    return;
                }

                showLoading('Limpando banco de dados...');
                populateBtn.disabled = true;
                clearBtn.disabled = true;

                try {
                    const response = await fetch('/debug/clear-db', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    const data = await response.json();

                    if (data.success) {
                        showToast(data.message, 'success');
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    } else {
                        showToast(data.message || 'Erro ao limpar banco de dados', 'error');
                    }
                } catch (error) {
                    showToast('Erro ao limpar banco de dados: ' + error.message, 'error');
                } finally {
                    hideLoading();
                    populateBtn.disabled = false;
                    clearBtn.disabled = false;
                }
            }

            populateBtn.addEventListener('click', populateDatabase);
            clearBtn.addEventListener('click', clearDatabase);
        })();
    </script>

    {% block scripts %}{% endblock %}
</body>
</html>
