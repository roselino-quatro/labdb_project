CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- 1.
CREATE TABLE PESSOA (
    CPF VARCHAR(11) NOT NULL,
    NOME VARCHAR(255) NOT NULL,
    EMAIL VARCHAR(255) NOT NULL,
    CELULAR VARCHAR(20),
    DATA_NASCIMENTO DATE,

    CONSTRAINT PK_PESSOA PRIMARY KEY (CPF),
    CONSTRAINT UN_PESSOA_EMAIL UNIQUE (EMAIL)
);

-- 2.
CREATE TABLE INTERNO_USP (
    CPF_PESSOA VARCHAR(11) NOT NULL,
    NUSP VARCHAR(10) NOT NULL,
    CATEGORIA VARCHAR(50) NOT NULL,

    CONSTRAINT PK_INTERNO_USP PRIMARY KEY (CPF_PESSOA),
    CONSTRAINT FK_INTERNO_USP_PESSOA FOREIGN KEY (CPF_PESSOA)
        REFERENCES PESSOA (CPF)
            ON DELETE CASCADE
            ON UPDATE CASCADE,
    CONSTRAINT UN_INTERNO_USP_NUSP UNIQUE (NUSP),
    CONSTRAINT CK_INTERNO_USP_CATEGORIA CHECK (
        CATEGORIA IN (
            'ALUNO_GRADUACAO',
            'ALUNO_MESTRADO',
            'ALUNO_DOUTORADO',
            'FUNCIONARIO'
        )
    )
);

-- 3.
CREATE TABLE FUNCIONARIO (
    CPF_INTERNO VARCHAR(11) NOT NULL,
    FORMACAO VARCHAR(100),

    CONSTRAINT PK_FUNCIONARIO PRIMARY KEY (CPF_INTERNO),
    CONSTRAINT FK_FUNCIONARIO_INTERNO FOREIGN KEY (CPF_INTERNO)
        REFERENCES INTERNO_USP (CPF_PESSOA)
            ON DELETE CASCADE
            ON UPDATE CASCADE
);

-- 4.
CREATE TABLE FUNCIONARIO_ATRIBUICAO (
    CPF_FUNCIONARIO VARCHAR(11) NOT NULL,
    ATRIBUICAO VARCHAR(255) NOT NULL,

    CONSTRAINT PK_FUNCIONARIO_ATRIBUICAO PRIMARY KEY (CPF_FUNCIONARIO, ATRIBUICAO),
    CONSTRAINT FK_ATRIBUICAO_FUNCIONARIO FOREIGN KEY (CPF_FUNCIONARIO)
        REFERENCES FUNCIONARIO (CPF_INTERNO)
            ON DELETE CASCADE
            ON UPDATE CASCADE
);

-- 5.
CREATE TABLE FUNCIONARIO_RESTRICAO (
    CPF_FUNCIONARIO VARCHAR(11) NOT NULL,
    RESTRICAO_FISICA VARCHAR(255) NOT NULL,

    CONSTRAINT PK_FUNCIONARIO_RESTRICAO PRIMARY KEY (CPF_FUNCIONARIO, RESTRICAO_FISICA),
    CONSTRAINT FK_RESTRICAO_FUNCIONARIO FOREIGN KEY (CPF_FUNCIONARIO)
        REFERENCES FUNCIONARIO (CPF_INTERNO)
            ON DELETE CASCADE
            ON UPDATE CASCADE
);

-- 6.
CREATE TABLE EDUCADOR_FISICO (
    CPF_FUNCIONARIO VARCHAR(11) NOT NULL,
    NUMERO_CONSELHO VARCHAR(20) NOT NULL,

    CONSTRAINT PK_EDUCADOR_FISICO PRIMARY KEY (CPF_FUNCIONARIO),
    CONSTRAINT FK_EDUCADOR_FISICO_FUNCIONARIO FOREIGN KEY (CPF_FUNCIONARIO)
        REFERENCES FUNCIONARIO (CPF_INTERNO)
            ON DELETE CASCADE
            ON UPDATE CASCADE,
    CONSTRAINT UN_EDUCADOR_FISICO_CONSELHO UNIQUE (NUMERO_CONSELHO)
);

-- 7.
CREATE TABLE INSTALACAO (
    ID_INSTALACAO INT GENERATED BY DEFAULT AS IDENTITY,
    NOME VARCHAR(100) NOT NULL,
    TIPO VARCHAR(50) NOT NULL,
    CAPACIDADE INT,
    EH_RESERVAVEL CHAR(1) NOT NULL,

    CONSTRAINT PK_INSTALACAO PRIMARY KEY (ID_INSTALACAO),
    CONSTRAINT UN_INSTALACAO UNIQUE (NOME, TIPO),
    CONSTRAINT CK_INSTALACAO_RESERVAVEL CHECK (EH_RESERVAVEL IN ('S', 'N'))
);

-- 8.
CREATE TABLE EQUIPAMENTO (
    ID_PATRIMONIO VARCHAR(50) NOT NULL,
    NOME VARCHAR(100) NOT NULL,
    ID_INSTALACAO_LOCAL INT,
    PRECO_AQUISICAO DECIMAL(10, 2),
    DATA_AQUISICAO DATE,

    CONSTRAINT PK_EQUIPAMENTO PRIMARY KEY (ID_PATRIMONIO),
    CONSTRAINT FK_EQUIPAMENTO_INSTALACAO FOREIGN KEY (ID_INSTALACAO_LOCAL)
        REFERENCES INSTALACAO (ID_INSTALACAO)
);

-- 9.
CREATE TABLE DOACAO (
    ID_EQUIPAMENTO VARCHAR(50) NOT NULL,
    CPF_DOADOR VARCHAR(11) NOT NULL,
    DATA_DOACAO DATE NOT NULL,

    CONSTRAINT PK_DOACAO PRIMARY KEY (ID_EQUIPAMENTO),
    CONSTRAINT FK_DOACAO_EQUIPAMENTO FOREIGN KEY (ID_EQUIPAMENTO)
        REFERENCES EQUIPAMENTO (ID_PATRIMONIO),
    CONSTRAINT FK_DOACAO_DOADOR FOREIGN KEY (CPF_DOADOR)
        REFERENCES PESSOA (CPF)
);

-- 10.
CREATE TABLE RESERVA (
    ID_RESERVA INT GENERATED BY DEFAULT AS IDENTITY,
    ID_INSTALACAO INT NOT NULL,
    CPF_RESPONSAVEL_INTERNO VARCHAR(11) NOT NULL,
    DATA_RESERVA DATE NOT NULL,
    HORARIO_INICIO TIME NOT NULL,
    HORARIO_FIM TIME NOT NULL,

    CONSTRAINT PK_RESERVA PRIMARY KEY (ID_RESERVA),
    CONSTRAINT FK_RESERVA_INSTALACAO FOREIGN KEY (ID_INSTALACAO)
        REFERENCES INSTALACAO (ID_INSTALACAO),
    CONSTRAINT FK_RESERVA_INTERNO FOREIGN KEY (CPF_RESPONSAVEL_INTERNO)
        REFERENCES INTERNO_USP (CPF_PESSOA),
    CONSTRAINT UN_RESERVA UNIQUE (ID_INSTALACAO, DATA_RESERVA, HORARIO_INICIO)
);

-- 11.
CREATE TABLE ATIVIDADE (
    ID_ATIVIDADE INT GENERATED BY DEFAULT AS IDENTITY,
    NOME VARCHAR(100) NOT NULL,
    VAGAS_LIMITE INT,
    DATA_INICIO_PERIODO DATE NOT NULL,
    DATA_FIM_PERIODO DATE,

    CONSTRAINT PK_ATIVIDADE PRIMARY KEY (ID_ATIVIDADE),
    CONSTRAINT UN_ATIVIDADE UNIQUE (NOME, DATA_INICIO_PERIODO)
);

CREATE TYPE DIA_SEMANA AS ENUM (
    'SEGUNDA',
    'TERCA',
    'QUARTA',
    'QUINTA',
    'SEXTA',
    'SABADO',
    'DOMINGO'
);

-- 12.
CREATE TABLE OCORRENCIA_SEMANAL (
    ID_OCORRENCIA INT GENERATED BY DEFAULT AS IDENTITY,
    ID_ATIVIDADE INT NOT NULL,
    ID_INSTALACAO INT NOT NULL,
    DIA_SEMANA DIA_SEMANA NOT NULL,
    HORARIO_INICIO TIME NOT NULL,
    HORARIO_FIM TIME NOT NULL,

    CONSTRAINT PK_OCORRENCIA PRIMARY KEY (ID_OCORRENCIA),
    CONSTRAINT FK_OCORRENCIA_ATIVIDADE FOREIGN KEY (ID_ATIVIDADE)
        REFERENCES ATIVIDADE(ID_ATIVIDADE),
    CONSTRAINT FK_OCORRENCIA_INSTALACAO FOREIGN KEY (ID_INSTALACAO)
        REFERENCES INSTALACAO(ID_INSTALACAO),
    CONSTRAINT UN_OCORRENCIA UNIQUE (ID_ATIVIDADE, ID_INSTALACAO, DIA_SEMANA, HORARIO_INICIO)
);

-- 13.
CREATE TABLE CONDUZ_ATIVIDADE (
    CPF_EDUCADOR_FISICO VARCHAR(11) NOT NULL,
    ID_ATIVIDADE INT NOT NULL,

    CONSTRAINT PK_CONDUZ_ATIVIDADE PRIMARY KEY (CPF_EDUCADOR_FISICO, ID_ATIVIDADE),
    CONSTRAINT FK_CONDUZ_EDUCADOR FOREIGN KEY (CPF_EDUCADOR_FISICO)
        REFERENCES EDUCADOR_FISICO(CPF_FUNCIONARIO),
    CONSTRAINT FK_CONDUZ_ATIVIDADE FOREIGN KEY (ID_ATIVIDADE)
        REFERENCES ATIVIDADE(ID_ATIVIDADE)
);

-- 14.
CREATE TABLE PARTICIPACAO_ATIVIDADE (
    CPF_PARTICIPANTE VARCHAR(11) NOT NULL,
    ID_ATIVIDADE INT NOT NULL,
    CPF_CONVIDANTE_INTERNO VARCHAR(11),
    DATA_INSCRICAO DATE NOT NULL,

    CONSTRAINT PK_PARTICIPACAO_ATIVIDADE PRIMARY KEY (CPF_PARTICIPANTE, ID_ATIVIDADE),
    CONSTRAINT FK_PARTICIPACAO_PESSOA FOREIGN KEY (CPF_PARTICIPANTE)
        REFERENCES PESSOA(CPF),
    CONSTRAINT FK_PARTICIPACAO_ATIVIDADE FOREIGN KEY (ID_ATIVIDADE)
        REFERENCES ATIVIDADE(ID_ATIVIDADE),
    CONSTRAINT FK_PARTICIPACAO_CONVIDANTE FOREIGN KEY (CPF_CONVIDANTE_INTERNO)
        REFERENCES INTERNO_USP(CPF_PESSOA)
);

-- 15.
CREATE TABLE EVENTO (
    ID_EVENTO INT GENERATED BY DEFAULT AS IDENTITY,
    NOME VARCHAR(255) NOT NULL,
    DESCRICAO TEXT,
    ID_RESERVA INT NOT NULL,

    CONSTRAINT PK_EVENTO PRIMARY KEY (ID_EVENTO),
    CONSTRAINT UN_EVENTO_NOME UNIQUE (NOME),
    CONSTRAINT FK_EVENTO_RESERVA FOREIGN KEY (ID_RESERVA)
        REFERENCES RESERVA (ID_RESERVA)
);

-- 16.
CREATE TABLE SUPERVISAO_EVENTO (
    CPF_FUNCIONARIO VARCHAR(11) NOT NULL,
    ID_EVENTO INT NOT NULL,

    CONSTRAINT PK_SUPERVISAO_EVENTO PRIMARY KEY (CPF_FUNCIONARIO, ID_EVENTO),
    CONSTRAINT FK_SUPERVISAO_FUNCIONARIO FOREIGN KEY (CPF_FUNCIONARIO)
        REFERENCES FUNCIONARIO(CPF_INTERNO),
    CONSTRAINT FK_SUPERVISAO_EVENTO FOREIGN KEY (ID_EVENTO)
        REFERENCES EVENTO(ID_EVENTO)
);

-- 17.
CREATE TABLE GRUPO_EXTENSAO (
    NOME_GRUPO VARCHAR(100) NOT NULL,
    DESCRICAO TEXT,
    CPF_RESPONSAVEL_INTERNO VARCHAR(11) NOT NULL,

    CONSTRAINT PK_GRUPO_EXTENSAO PRIMARY KEY (NOME_GRUPO),
    CONSTRAINT FK_GRUPO_EXTENSAO_RESPONSAVEL FOREIGN KEY (CPF_RESPONSAVEL_INTERNO)
        REFERENCES INTERNO_USP (CPF_PESSOA)
);

-- 18.
CREATE TABLE ATIVIDADE_GRUPO_EXTENSAO (
    ID_ATIVIDADE INT NOT NULL,
    NOME_GRUPO VARCHAR(100) NOT NULL,

    CONSTRAINT PK_ATIVIDADE_GRUPO_EXTENSAO PRIMARY KEY (ID_ATIVIDADE, NOME_GRUPO),
    CONSTRAINT FK_ATIV_GRUPO_ATIV FOREIGN KEY (ID_ATIVIDADE)
        REFERENCES ATIVIDADE(ID_ATIVIDADE),
    CONSTRAINT FK_ATIV_GRUPO_GRUPO FOREIGN KEY (NOME_GRUPO)
        REFERENCES GRUPO_EXTENSAO(NOME_GRUPO)
);

-- 19.
CREATE TABLE CONVITE_EXTERNO (
    ID_CONVITE INT GENERATED BY DEFAULT AS IDENTITY,
    CPF_CONVIDANTE VARCHAR(11) NOT NULL,
    DOCUMENTO_CONVIDADO VARCHAR(20) NOT NULL,
    NOME_CONVIDADO VARCHAR(255) NOT NULL,
    EMAIL_CONVIDADO VARCHAR(255),
    TELEFONE_CONVIDADO VARCHAR(20),
    ID_ATIVIDADE INT,
    STATUS VARCHAR(20) NOT NULL DEFAULT 'PENDENTE',
    TOKEN VARCHAR(64) NOT NULL,
    DATA_CONVITE TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    DATA_RESPOSTA TIMESTAMP,
    OBSERVACOES TEXT,

    CONSTRAINT PK_CONVITE_EXTERNO PRIMARY KEY (ID_CONVITE),
    CONSTRAINT UN_CONVITE_EXTERNO_TOKEN UNIQUE (TOKEN),
    CONSTRAINT FK_CONVITE_EXTERNO_CONVIDANTE FOREIGN KEY (CPF_CONVIDANTE)
        REFERENCES INTERNO_USP (CPF_PESSOA),
    CONSTRAINT FK_CONVITE_EXTERNO_ATIVIDADE FOREIGN KEY (ID_ATIVIDADE)
        REFERENCES ATIVIDADE (ID_ATIVIDADE),
    CONSTRAINT CK_CONVITE_EXTERNO_STATUS CHECK (STATUS IN ('PENDENTE', 'ACEITO', 'RECUSADO', 'CANCELADO'))
);

-- 20.
CREATE TABLE EMPRESTIMO_EQUIPAMENTO (
    ID_EMPRESTIMO INT GENERATED BY DEFAULT AS IDENTITY,
    ID_EQUIPAMENTO VARCHAR(50) NOT NULL,
    CPF_RESPONSAVEL_INTERNO VARCHAR(11) NOT NULL,
    QUANTIDADE INT NOT NULL CHECK (QUANTIDADE > 0),
    DATA_EMPRESTIMO DATE NOT NULL,
    DATA_DEVOLUCAO_PREVISTA DATE,
    DATA_DEVOLUCAO_REAL DATE,
    STATUS VARCHAR(20) NOT NULL DEFAULT 'EM_PREPARACAO',
    OBSERVACOES TEXT,

    CONSTRAINT PK_EMPRESTIMO_EQUIPAMENTO PRIMARY KEY (ID_EMPRESTIMO),
    CONSTRAINT FK_EMPRESTIMO_EQUIPAMENTO_ITEM FOREIGN KEY (ID_EQUIPAMENTO)
        REFERENCES EQUIPAMENTO (ID_PATRIMONIO),
    CONSTRAINT FK_EMPRESTIMO_EQUIPAMENTO_RESPONSAVEL FOREIGN KEY (CPF_RESPONSAVEL_INTERNO)
        REFERENCES INTERNO_USP (CPF_PESSOA),
    CONSTRAINT CK_EMPRESTIMO_EQUIPAMENTO_STATUS CHECK (
        STATUS IN ('EM_PREPARACAO', 'RETIRADO', 'DEVOLVIDO', 'CANCELADO')
    )
);

-- 21.
CREATE TABLE AUDITORIA_LOGIN (
    ID_LOG INT GENERATED BY DEFAULT AS IDENTITY,
    TIMESTAMP_EVENTO TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    EMAIL_USUARIO VARCHAR(255),
    IP_ORIGEM VARCHAR(45),
    STATUS VARCHAR(20) NOT NULL,
    MENSAGEM TEXT,

    CONSTRAINT PK_AUDITORIA_LOGIN PRIMARY KEY (ID_LOG),
    CONSTRAINT CK_AUDITORIA_LOGIN_STATUS CHECK (
        STATUS IN ('SUCCESS', 'FAILURE', 'LOCKED')
    )
);

-- 22.
CREATE TABLE METRICA_ACESSO_DIARIA (
    DATA_REFERENCIA DATE NOT NULL,
    TOTAL_INTERNOS INT NOT NULL DEFAULT 0,
    TOTAL_EXTERNOS INT NOT NULL DEFAULT 0,
    TOTAL_FUNCIONARIOS INT NOT NULL DEFAULT 0,

    CONSTRAINT PK_METRICA_ACESSO PRIMARY KEY (DATA_REFERENCIA),
    CONSTRAINT CK_METRICA_ACESSO_INTERNOS CHECK (TOTAL_INTERNOS >= 0),
    CONSTRAINT CK_METRICA_ACESSO_EXTERNOS CHECK (TOTAL_EXTERNOS >= 0),
    CONSTRAINT CK_METRICA_ACESSO_FUNCIONARIOS CHECK (TOTAL_FUNCIONARIOS >= 0)
);

-- 23.
CREATE TABLE AUTH_ROLE (
    ROLE_KEY VARCHAR(50) NOT NULL,
    LABEL VARCHAR(100) NOT NULL,
    DESCRIPTION TEXT,
    DEFAULT_ENDPOINT VARCHAR(255) NOT NULL,
    PRIORITY INT NOT NULL DEFAULT 100,

    CONSTRAINT PK_AUTH_ROLE PRIMARY KEY (ROLE_KEY)
);

INSERT INTO AUTH_ROLE (ROLE_KEY, LABEL, DESCRIPTION, DEFAULT_ENDPOINT, PRIORITY)
VALUES
    ('admin', 'Administrator', 'Full management access', '/admin', 10),
    ('staff', 'Staff', 'CEFER operational staff', '/staff', 20),
    ('internal', 'Internal USP', 'Internal USP participants', '/internal', 30),
    ('external', 'External Guest', 'External invitees', '/external', 40)
ON CONFLICT (ROLE_KEY) DO NOTHING;

-- 24.
CREATE TABLE AUTH_USER (
    USER_ID INT GENERATED BY DEFAULT AS IDENTITY,
    CPF VARCHAR(11) NOT NULL,
    EMAIL VARCHAR(255) NOT NULL,
    PASSWORD_HASH TEXT NOT NULL,
    IS_ACTIVE BOOLEAN NOT NULL DEFAULT TRUE,
    CREATED_AT TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT PK_AUTH_USER PRIMARY KEY (USER_ID),
    CONSTRAINT FK_AUTH_USER_PESSOA FOREIGN KEY (CPF)
        REFERENCES PESSOA (CPF)
            ON DELETE CASCADE
            ON UPDATE CASCADE,
    CONSTRAINT UN_AUTH_USER_CPF UNIQUE (CPF)
);

CREATE UNIQUE INDEX IF NOT EXISTS IDX_AUTH_USER_EMAIL_CI
    ON AUTH_USER (LOWER(EMAIL));

-- 25.
CREATE TABLE AUTH_USER_ROLE (
    USER_ID INT NOT NULL,
    ROLE_KEY VARCHAR(50) NOT NULL,
    ASSIGNED_AT TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT PK_AUTH_USER_ROLE PRIMARY KEY (USER_ID, ROLE_KEY),
    CONSTRAINT FK_AUTH_USER_ROLE_USER FOREIGN KEY (USER_ID)
        REFERENCES AUTH_USER (USER_ID)
            ON DELETE CASCADE,
    CONSTRAINT FK_AUTH_USER_ROLE_ROLE FOREIGN KEY (ROLE_KEY)
        REFERENCES AUTH_ROLE (ROLE_KEY)
            ON DELETE CASCADE
);

CREATE INDEX IF NOT EXISTS IDX_AUTH_USER_ROLE_ROLE
    ON AUTH_USER_ROLE (ROLE_KEY);

-- 26.
ALTER TABLE AUDITORIA_LOGIN
    ADD COLUMN IF NOT EXISTS USER_ID INT,
    ADD COLUMN IF NOT EXISTS EVENT_TYPE VARCHAR(20) NOT NULL DEFAULT 'LOGIN',
    ADD COLUMN IF NOT EXISTS CLIENT_IDENTIFIER VARCHAR(255);

ALTER TABLE AUDITORIA_LOGIN
    ADD CONSTRAINT FK_AUDITORIA_LOGIN_USER
        FOREIGN KEY (USER_ID)
        REFERENCES AUTH_USER (USER_ID)
            ON DELETE SET NULL;
