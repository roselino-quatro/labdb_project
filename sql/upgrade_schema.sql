-- 1.
CREATE TABLE PESSOA (
    CPF VARCHAR(11) NOT NULL,
    NOME VARCHAR(255) NOT NULL,
    EMAIL VARCHAR(255) NOT NULL,
    CELULAR VARCHAR(20),
    DATA_NASCIMENTO DATE,

    CONSTRAINT PK_PESSOA PRIMARY KEY (CPF),
    CONSTRAINT UN_PESSOA_EMAIL UNIQUE (EMAIL)
);

-- 2.
CREATE TABLE INTERNO_USP (
    CPF_PESSOA VARCHAR(11) NOT NULL,
    NUSP VARCHAR(10) NOT NULL,
    CATEGORIA VARCHAR(50) NOT NULL,
    
    CONSTRAINT PK_INTERNO_USP PRIMARY KEY (CPF_PESSOA),
    CONSTRAINT FK_INTERNO_USP_PESSOA FOREIGN KEY (CPF_PESSOA)
        REFERENCES PESSOA (CPF)
            ON DELETE CASCADE
            ON UPDATE CASCADE,
    CONSTRAINT UN_INTERNO_USP_NUSP UNIQUE (NUSP),
    CONSTRAINT CK_INTERNO_USP_CATEGORIA CHECK (
        CATEGORIA IN (
            'ALUNO_GRADUACAO', 
            'ALUNO_MESTRADO', 
            'ALUNO_DOUTORADO', 
            'FUNCIONARIO'
        )
    )
);

-- 3.
CREATE TABLE FUNCIONARIO (
    CPF_INTERNO VARCHAR(11) NOT NULL,
    FORMACAO VARCHAR(100),

    CONSTRAINT PK_FUNCIONARIO PRIMARY KEY (CPF_INTERNO),
    CONSTRAINT FK_FUNCIONARIO_INTERNO FOREIGN KEY (CPF_INTERNO)
        REFERENCES INTERNO_USP (CPF_PESSOA)
            ON DELETE CASCADE 
            ON UPDATE CASCADE
);

-- 4. 
CREATE TABLE FUNCIONARIO_ATRIBUICAO (
    CPF_FUNCIONARIO VARCHAR(11) NOT NULL,
    ATRIBUICAO VARCHAR(255) NOT NULL,
    
    CONSTRAINT PK_FUNCIONARIO_ATRIBUICAO PRIMARY KEY (CPF_FUNCIONARIO, ATRIBUICAO),
    CONSTRAINT FK_ATRIBUICAO_FUNCIONARIO FOREIGN KEY (CPF_FUNCIONARIO)
        REFERENCES FUNCIONARIO (CPF_INTERNO)
            ON DELETE CASCADE
            ON UPDATE CASCADE
);

-- 5.
CREATE TABLE FUNCIONARIO_RESTRICAO (
    CPF_FUNCIONARIO VARCHAR(11) NOT NULL,
    RESTRICAO_FISICA VARCHAR(255) NOT NULL,

    CONSTRAINT PK_FUNCIONARIO_RESTRICAO PRIMARY KEY (CPF_FUNCIONARIO, RESTRICAO_FISICA),
    CONSTRAINT FK_RESTRICAO_FUNCIONARIO FOREIGN KEY (CPF_FUNCIONARIO)
        REFERENCES FUNCIONARIO (CPF_INTERNO)
            ON DELETE CASCADE
            ON UPDATE CASCADE
);

-- 6. 
CREATE TABLE EDUCADOR_FISICO (
    CPF_FUNCIONARIO VARCHAR(11) NOT NULL,
    NUMERO_CONSELHO VARCHAR(20) NOT NULL,
    
    CONSTRAINT PK_EDUCADOR_FISICO PRIMARY KEY (CPF_FUNCIONARIO),
    CONSTRAINT FK_EDUCADOR_FISICO_FUNCIONARIO FOREIGN KEY (CPF_FUNCIONARIO)
        REFERENCES FUNCIONARIO (CPF_INTERNO)
            ON DELETE CASCADE
            ON UPDATE CASCADE,
    CONSTRAINT UN_EDUCADOR_FISICO_CONSELHO UNIQUE (NUMERO_CONSELHO)
);

-- 7.
CREATE TABLE INSTALACAO (
    ID_INSTALACAO INT GENERATED BY DEFAULT AS IDENTITY,
    NOME VARCHAR(100) NOT NULL,
    TIPO VARCHAR(50) NOT NULL,
    CAPACIDADE INT,
    EH_RESERVAVEL CHAR(1) NOT NULL,

    CONSTRAINT PK_INSTALACAO PRIMARY KEY (ID_INSTALACAO),
    CONSTRAINT UN_INSTALACAO UNIQUE (NOME, TIPO),
    CONSTRAINT CK_INSTALACAO_RESERVAVEL CHECK (EH_RESERVAVEL IN ('S', 'N'))
);

-- 8. 
CREATE TABLE EQUIPAMENTO (
    ID_PATRIMONIO VARCHAR(50) NOT NULL,
    NOME VARCHAR(100) NOT NULL,
    ID_INSTALACAO_LOCAL INT,
    PRECO_AQUISICAO DECIMAL(10, 2),
    DATA_AQUISICAO DATE,
    EH_RESERVAVEL CHAR(1) NOT NULL,

    CONSTRAINT PK_EQUIPAMENTO PRIMARY KEY (ID_PATRIMONIO),
    CONSTRAINT FK_EQUIPAMENTO_INSTALACAO FOREIGN KEY (ID_INSTALACAO_LOCAL)
        REFERENCES INSTALACAO (ID_INSTALACAO),
    CONSTRAINT CK_EQUIPAMENTO_RESERVAVEL CHECK (EH_RESERVAVEL IN ('S', 'N'))
);

-- 9.
CREATE TABLE DOACAO (
    ID_EQUIPAMENTO VARCHAR(50) NOT NULL,
    CPF_DOADOR VARCHAR(11) NOT NULL,
    DATA_DOACAO DATE NOT NULL,

    CONSTRAINT PK_DOACAO PRIMARY KEY (ID_EQUIPAMENTO),
    CONSTRAINT FK_DOACAO_EQUIPAMENTO FOREIGN KEY (ID_EQUIPAMENTO)
        REFERENCES EQUIPAMENTO (ID_PATRIMONIO),
    CONSTRAINT FK_DOACAO_DOADOR FOREIGN KEY (CPF_DOADOR)
        REFERENCES PESSOA (CPF)
);

-- 10.
CREATE TABLE RESERVA (
    ID_RESERVA INT GENERATED BY DEFAULT AS IDENTITY,
    ID_INSTALACAO INT NOT NULL,
    CPF_RESPONSAVEL_INTERNO VARCHAR(11) NOT NULL,
    DATA_RESERVA DATE NOT NULL,
    HORARIO_INICIO TIME NOT NULL,
    HORARIO_FIM TIME NOT NULL,

    CONSTRAINT PK_RESERVA PRIMARY KEY (ID_RESERVA),
    CONSTRAINT FK_RESERVA_INSTALACAO FOREIGN KEY (ID_INSTALACAO)
        REFERENCES INSTALACAO (ID_INSTALACAO),
    CONSTRAINT FK_RESERVA_INTERNO FOREIGN KEY (CPF_RESPONSAVEL_INTERNO)
        REFERENCES INTERNO_USP (CPF_PESSOA),
    CONSTRAINT UN_RESERVA UNIQUE (ID_INSTALACAO, DATA_RESERVA, HORARIO_INICIO)
);

-- 11. 
CREATE TABLE ATIVIDADE (
    ID_ATIVIDADE INT GENERATED BY DEFAULT AS IDENTITY,
    NOME VARCHAR(100) NOT NULL,
    VAGAS_LIMITE INT,
    DATA_INICIO_PERIODO DATE NOT NULL,
    DATA_FIM_PERIODO DATE,

    CONSTRAINT PK_ATIVIDADE PRIMARY KEY (ID_ATIVIDADE),
    CONSTRAINT UN_ATIVIDADE UNIQUE (NOME, DATA_INICIO_PERIODO)
);

CREATE TYPE DIA_SEMANA AS ENUM (
    'SEGUNDA', 
    'TERCA', 
    'QUARTA', 
    'QUINTA', 
    'SEXTA', 
    'SABADO', 
    'DOMINGO'
);

-- 12. 
CREATE TABLE OCORRENCIA_SEMANAL (
    ID_OCORRENCIA INT GENERATED BY DEFAULT AS IDENTITY,
    ID_ATIVIDADE INT NOT NULL,
    ID_INSTALACAO INT NOT NULL,
    DIA_SEMANA DIA_SEMANA NOT NULL,
    HORARIO_INICIO TIME NOT NULL,
    HORARIO_FIM TIME NOT NULL,

    CONSTRAINT PK_OCORRENCIA PRIMARY KEY (ID_OCORRENCIA),
    CONSTRAINT FK_OCORRENCIA_ATIVIDADE FOREIGN KEY (ID_ATIVIDADE) 
        REFERENCES ATIVIDADE(ID_ATIVIDADE),
    CONSTRAINT FK_OCORRENCIA_INSTALACAO FOREIGN KEY (ID_INSTALACAO) 
        REFERENCES INSTALACAO(ID_INSTALACAO),
    CONSTRAINT UN_OCORRENCIA UNIQUE (ID_ATIVIDADE, ID_INSTALACAO, DIA_SEMANA, HORARIO_INICIO)
);

-- 13. 
CREATE TABLE CONDUZ_ATIVIDADE (
    CPF_EDUCADOR_FISICO VARCHAR(11) NOT NULL,
    ID_ATIVIDADE INT NOT NULL,

    CONSTRAINT PK_CONDUZ_ATIVIDADE PRIMARY KEY (CPF_EDUCADOR_FISICO, ID_ATIVIDADE),
    CONSTRAINT FK_CONDUZ_EDUCADOR FOREIGN KEY (CPF_EDUCADOR_FISICO) 
        REFERENCES EDUCADOR_FISICO(CPF_FUNCIONARIO),
    CONSTRAINT FK_CONDUZ_ATIVIDADE FOREIGN KEY (ID_ATIVIDADE) 
        REFERENCES ATIVIDADE(ID_ATIVIDADE)
);

-- 14. 
CREATE TABLE PARTICIPACAO_ATIVIDADE (
    CPF_PARTICIPANTE VARCHAR(11) NOT NULL,
    ID_ATIVIDADE INT NOT NULL,
    CPF_CONVIDANTE_INTERNO VARCHAR(11),
    DATA_INSCRICAO DATE NOT NULL,

    CONSTRAINT PK_PARTICIPACAO_ATIVIDADE PRIMARY KEY (CPF_PARTICIPANTE, ID_ATIVIDADE),
    CONSTRAINT FK_PARTICIPACAO_PESSOA FOREIGN KEY (CPF_PARTICIPANTE) 
        REFERENCES PESSOA(CPF),
    CONSTRAINT FK_PARTICIPACAO_ATIVIDADE FOREIGN KEY (ID_ATIVIDADE) 
        REFERENCES ATIVIDADE(ID_ATIVIDADE),
    CONSTRAINT FK_PARTICIPACAO_CONVIDANTE FOREIGN KEY (CPF_CONVIDANTE_INTERNO) 
        REFERENCES INTERNO_USP(CPF_PESSOA)
);

-- 15. 
CREATE TABLE EVENTO (
    ID_EVENTO INT GENERATED BY DEFAULT AS IDENTITY,
    NOME VARCHAR(255) NOT NULL,
    DESCRICAO TEXT,
    ID_RESERVA INT NOT NULL,

    CONSTRAINT PK_EVENTO PRIMARY KEY (ID_EVENTO),
    CONSTRAINT UN_EVENTO_NOME UNIQUE (NOME),
    CONSTRAINT FK_EVENTO_RESERVA FOREIGN KEY (ID_RESERVA)
        REFERENCES RESERVA (ID_RESERVA)
);

-- 16.
CREATE TABLE SUPERVISAO_EVENTO (
    CPF_FUNCIONARIO VARCHAR(11) NOT NULL,
    ID_EVENTO INT NOT NULL,

    CONSTRAINT PK_SUPERVISAO_EVENTO PRIMARY KEY (CPF_FUNCIONARIO, ID_EVENTO),
    CONSTRAINT FK_SUPERVISAO_FUNCIONARIO FOREIGN KEY (CPF_FUNCIONARIO) 
        REFERENCES FUNCIONARIO(CPF_INTERNO),
    CONSTRAINT FK_SUPERVISAO_EVENTO FOREIGN KEY (ID_EVENTO) 
        REFERENCES EVENTO(ID_EVENTO)
);

-- 17. 
CREATE TABLE GRUPO_EXTENSAO (
    NOME_GRUPO VARCHAR(100) NOT NULL,
    DESCRICAO TEXT,
    CPF_RESPONSAVEL_INTERNO VARCHAR(11) NOT NULL,

    CONSTRAINT PK_GRUPO_EXTENSAO PRIMARY KEY (NOME_GRUPO),
    CONSTRAINT FK_GRUPO_EXTENSAO_RESPONSAVEL FOREIGN KEY (CPF_RESPONSAVEL_INTERNO)
        REFERENCES INTERNO_USP (CPF_PESSOA)
);

-- 18.
CREATE TABLE ATIVIDADE_GRUPO_EXTENSAO (
    ID_ATIVIDADE INT NOT NULL,
    NOME_GRUPO VARCHAR(100) NOT NULL,

    CONSTRAINT PK_ATIVIDADE_GRUPO_EXTENSAO PRIMARY KEY (ID_ATIVIDADE, NOME_GRUPO),
    CONSTRAINT FK_ATIV_GRUPO_ATIV FOREIGN KEY (ID_ATIVIDADE) 
        REFERENCES ATIVIDADE(ID_ATIVIDADE),
    CONSTRAINT FK_ATIV_GRUPO_GRUPO FOREIGN KEY (NOME_GRUPO) 
        REFERENCES GRUPO_EXTENSAO(NOME_GRUPO)
);

--19
CREATE TABLE RESERVA_EQUIPAMENTO (
    ID_RESERVA_EQUIP INT GENERATED BY DEFAULT AS IDENTITY,
    ID_EQUIPAMENTO VARCHAR(50) NOT NULL,
    CPF_RESPONSAVEL_INTERNO VARCHAR(11) NOT NULL,
    DATA_RESERVA DATE NOT NULL,
    HORARIO_INICIO TIME NOT NULL,
    HORARIO_FIM TIME NOT NULL,

    CONSTRAINT PK_RESERVA_EQUIPAMENTO PRIMARY KEY (ID_RESERVA_EQUIP),
    CONSTRAINT FK_RESERVA_EQUIP_EQUIPAMENTO FOREIGN KEY (ID_EQUIPAMENTO)
        REFERENCES EQUIPAMENTO (ID_PATRIMONIO)
        ON DELETE CASCADE
        ON UPDATE CASCADE,
    CONSTRAINT FK_RESERVA_EQUIP_INTERNO FOREIGN KEY (CPF_RESPONSAVEL_INTERNO)
        REFERENCES INTERNO_USP (CPF_PESSOA)
        ON DELETE CASCADE
        ON UPDATE CASCADE,
    CONSTRAINT CK_RESERVA_EQUIP_HORARIO CHECK (HORARIO_FIM > HORARIO_INICIO)
);